# 4: Формат сообщения

Date: 2025-09-12

## Стаус

Принят

## Проблема

В EventDriven-архитектуре микросервисы обмениваются сообщениями. Так как мы используем RabbitMQ, то обмениваться мы будем фактически строковыми значениями. Де-факто в событийной архитектуре мы обмениваемся data-объектами со сложной структурой. Если микросервис будет получать сообщение неожиданного формата, это будет приводить к ошибкам. Ошибок будет тем больше, чем больше разнообразных форматов сообщений будет в системе.

## Решение

Не хотелось бы вводить жесткую структуру сообщений, так как со временем захочется ее расширять без необходимости передеплоить всю связку микросервисов. Не хотелось бы задействовать реестр схем, который популярен в языках со статической типизацией.

Поэтому логично, если в памяти программы у нас data-объект будет представлен в виде Hash-а, а в брокер сообщений мы будем передавать JSON.

На первом уровне JSON-объекта располагаются мета-поля, фактически заголовки нашего сообщения. Специальное поле payload содержит полезную нагрузку сообщения. Формат payload произвольный, однако, он обязательно должен содержать сквозной идентификатор attachment_id (см ADR 0004-correlation-id.md).

```json
{
  "action": "attachment_registered",
  "payload": {
    "md5": "3877e0c18077c6f966774322d12d982a",
    "file": "5775dae8f4b10.jpeg",
    "full_path": "attachment/2025-10-29/775dae8f4b10.jpeg",
    "created_at": 1761736885,
    "attachment_id": "550e8400-e29b-41d4-a716-446655440000"
  },
  "created_at": 1761736890,
  "routing_key": "attachment_registered",
  "reply_to": "..."
}
```

Среди обязательных полей:

* action — действие, которое должна выполнить другая система с этим data-объектом
* created_at - время создания сообщения
* routing_key - маршрутный ключ, который связывает канал отправки сообщения с очередью, в которое оно должно попасть

Среди необязательных полей:

* reply_to - используется в запросах с обязательным ответом, чтобы указать название очереди, куда необходимо отправить ответ

## Заключение

В качестве сквозного идентификатора используется 128-битныйы uuid-ключ attachment_id, создаваемый лишь в одном месте: inbox.
